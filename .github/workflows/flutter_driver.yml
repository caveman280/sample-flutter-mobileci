# Name of your workflow.
name: Flutter Driver

# Trigger the workflow on push or pull request.
on:
  push:
    # Sequence of patterns matched against refs/heads
    paths-ignore:
    - 'screenshots/**'
    branches:
      # Push events on main branch
      - main
      - master

# A workflow run is made up of one or more jobs.
jobs:
  # id of job, a string that is unique to the "jobs" node above.
  drive_ios:
    name: iOS Flutter Driver
    # Creates a build matrix for your jobs. You can define different
    # variations of an environment to run each job in.
    strategy:
      # A set of different configurations of the virtual environment.
      matrix:
        device:
          - "iPhone 8 (14.0)"
          - "iPhone 11 Pro Max (14.0)"
      # When set to true, GitHub cancels all in-progress jobs if any matrix job
      # fails.
      fail-fast: false
    # The type of machine to run the job on.
    runs-on: macOS-latest
    # Contains a sequence of tasks.
    steps:
      # A name for your step to display on GitHub.
      - name: "List all simulators"
        run: "xcrun instruments -s"
      - name: "Start Simulator"
        run: |
          UDID=$(
            xcrun instruments -s |
            awk \
              -F ' *[][]' \
              -v 'device=${{ matrix.device }}' \
              '$1 == device { print $2 }'
          )
          xcrun simctl boot "${UDID:?No Simulator with this name found}"
      # The branch or tag ref that triggered the workflow will be checked out.
      # https://github.com/marketplace/actions/checkout
      - uses: actions/checkout@v2
        name: "Checkout Code"
      # Sets up a flutter environment.
      # https://github.com/marketplace/actions/flutter-action
      - uses: subosito/flutter-action@v1
        name: "Install Flutter"
        with:
          # Don't pin Flutter version, it'll default to latest
          #flutter-version: '1.22.3'
          channel: "stable" # or: 'dev' or 'beta'
      - name: "Run Flutter Driver tests"
        run: |
          flutter pub get
          flutter drive --target=test_driver/main.dart
      - name: Upload Screenshot
        uses: actions/upload-artifact@master
        with:
          name: iOS - Screenshots - ${{ matrix.device }}
          path: /tmp/screenshots

  drive_android:
    name: Android Flutter Driver
    # The type of machine to run the job on.
    runs-on: macos-latest
    # creates a build matrix for your jobs
    strategy:
      # set of different configurations of the virtual environment.
      matrix:
        api-level: [21, 29]
        target: [default]
      # When set to true, GitHub cancels all in-progress jobs if any matrix job
      # fails.
      fail-fast: false
    steps:
      - uses: actions/checkout@v2
      - name: "Install ffmpeg"
        if: matrix.api-level == '29'
        run: brew update && brew install ffmpeg
      - uses: subosito/flutter-action@v1
        with:
          channel: "stable" # or: 'dev' or 'beta'
      # - name: Setup tmate session
      #   uses: mxschmitt/action-tmate@v3
      - name: "Run Flutter Driver tests and screen record"
        # GitHub Action for installing, configuring and running Android Emulators (work only Mac OS)
        # https://github.com/marketplace/actions/android-emulator-runner
        uses: reactivecircus/android-emulator-runner@v2
        if: matrix.api-level == '29'
        env:
          APILEVEL: ${{ matrix.api-level }}
        with:
          api-level: ${{ matrix.api-level }}
          target: ${{ matrix.target }}
          arch: x86_64
          profile: Nexus 6
          emulator-options: -no-window -gpu swiftshader_indirect -no-snapshot -noaudio -no-boot-anim -writable-system
          ## retry 3 times
          script: |
            flutter drive test_driver/main.dart || flutter drive test_driver/main.dart || flutter drive test_driver/main.dart
            adb pull /sdcard/screenrecord.mp4 /tmp/screenshots
      - name: "Run Flutter Driver tests"
        if: matrix.api-level != '29'
        # GitHub Action for installing, configuring and running Android Emulators (work only Mac OS)
        # https://github.com/marketplace/actions/android-emulator-runner
        uses: reactivecircus/android-emulator-runner@v2
        env:
          APILEVEL: ${{ matrix.api-level }}
        with:
          api-level: ${{ matrix.api-level }}
          target: ${{ matrix.target }}
          arch: x86_64
          profile: Nexus 6
          emulator-options: -no-window -gpu swiftshader_indirect -no-snapshot -noaudio -no-boot-anim -writable-system
          ## retry 3 times
          script:  flutter drive test_driver/main.dart || flutter drive test_driver/main.dart || flutter drive test_driver/main.dart
      - name: "Convert to GIF"
        if: matrix.api-level == '29'
        run: |
          cd /tmp/screenshots
          ffmpeg -i screenrecord.mp4 -vf "fps=10,scale=320:-1:flags=lanczos,split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse" -loop 0 screenrecord.gif
          rm screenrecord.mp4
      - name: Upload Screenshots
        uses: actions/upload-artifact@master
        with:
          name: Android - Screenshots - API Level ${{ matrix.api-level }}
          path: /tmp/screenshots

  commit_screenshots:
    name: Commit Screenshots
    # The type of machine to run the job on.
    runs-on: ubuntu-latest
    needs: [drive_android, drive_ios]
    steps:
      - uses: actions/checkout@v2
      - name: "Remove Old Screenshots"
        run: if [ -d ./screenshots ]; then rm -Rf ./screenshots/*; else mkdir ./screenshots; fi
      - uses: actions/download-artifact@v2
        name: "Download all artifcats"
        with:
          path: screenshots
      - name: "Copy GIF for README.md"
        run: cp screenshots/Android\ -\ Screenshots\ -\ API\ Level\ 29/screenrecord.gif screenshots/
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v3
        with:
          commit-message: 'ðŸ“± Update Screenshots'
          branch: "update-screenshots-${{ github.run_id }}"
          delete-branch: true
          title: '[NO CI] Update screenshots'
          body: |
            Update the screenshots
            - Auto-generated by [create-pull-request][1]

            [1]: https://github.com/peter-evans/create-pull-request
          labels: |
            no ci
            automated pr
          draft: false
      - name: "Merge Pull Request"
        uses: "actions/github-script@v2"
        env:
          PULL_REQUEST_NUMBER: "${{ steps.cpr.outputs.pull-request-number }}"
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const pullRequest = parseInt(process.env.PULL_REQUEST_NUMBER as string)
            const repository = context.repo

            await github.pulls.merge({
              merge_method: "rebase",
              owner: repository.owner,
              pull_number: pullRequest,
              repo: repository.repo,
            })
